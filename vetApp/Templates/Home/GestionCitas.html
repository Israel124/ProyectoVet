{% extends 'shared/base.html' %} {% block title %}VetCare - Gestión de Citas
{%endblock %} {% block content %}
<div class="container mt-4">
  <!-- Mensajes de alerta -->
  {% if messages %}
  <div class="messages mb-4">
    {% for message in messages %}
    <div
      class="alert alert-{{ message.tags }} alert-dismissible fade show"
      role="alert"
    >
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Encabezado del dashboard -->
  <div class="dashboard-header bg-white rounded-4 shadow-sm p-4 mb-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h2 class="fw-bold mb-3">
          <i class="fas fa-calendar-alt text-primary me-2"></i> Gestión de Citas
        </h2>
        <p class="text-muted mb-0">
          Administre las citas programadas para sus pacientes
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <button class="btn btn-primary px-4 py-2" id="newAppointmentBtn">
          <i class="fas fa-plus me-1"></i> Nueva Cita
        </button>
      </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mt-4">
      <div class="col-md-4 mb-3 mb-md-0">
        <div class="stats-card stats-pending rounded-4 p-3 text-center">
          <div class="stats-number fw-bold fs-2 mb-1">3</div>
          <div>Citas Pendientes</div>
        </div>
      </div>
      <div class="col-md-4 mb-3 mb-md-0">
        <div class="stats-card stats-accepted rounded-4 p-3 text-center">
          <div class="stats-number fw-bold fs-2 mb-1">3</div>
          <div>Citas Confirmadas</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card stats-rejected rounded-4 p-3 text-center">
          <div class="stats-number fw-bold fs-2 mb-1">1</div>
          <div>Citas Canceladas</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Columna principal para listar citas -->
    <div class="col-lg-8 mb-4">
      <!-- Filtros y búsqueda -->
      <div class="filter-card bg-white rounded-4 shadow-sm p-4 mb-4">
        <div class="row g-3">
          <div class="col-md-5">
            <div class="search-container position-relative">
              <i
                class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"
              ></i>
              <input
                type="text"
                class="form-control search-input ps-5"
                placeholder="Buscar citas..."
              />
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="filterStatus">
              <option value="all">Todas las citas</option>
              <option value="pending" selected>Pendientes</option>
              <option value="accepted">Confirmadas</option>
              <option value="rejected">Canceladas</option>
            </select>
          </div>
          <div class="col-md-4">
            <input type="date" class="form-control" id="filterDate" />
          </div>
        </div>
      </div>

      <!-- Listado de citas -->
      <div id="appointmentsList" class="row g-4">
        <!-- Las citas se cargarán dinámicamente -->
      </div>
    </div>

    <!-- Columna secundaria para formulario y gráficos -->
    <div class="col-lg-4">
      <!-- Formulario CRUD -->
      <div class="form-section bg-white rounded-4 shadow-sm p-4 mb-4">
        <h5 class="mb-4 fw-bold">
          <i class="fas fa-calendar-plus me-2 text-primary"></i> Programar Cita
        </h5>
        <form id="appointmentForm">
          <input type="hidden" id="appointmentId" />

          <!-- Información de la mascota -->
          <div class="mb-4">
            <h6
              class="section-title fw-bold text-primary border-bottom pb-2 mb-3"
            >
              <i class="fas fa-paw me-2"></i> Datos de la Mascota
            </h6>
            <div class="mb-3">
              <label for="petName" class="form-label fw-medium">Nombre</label>
              <input type="text" class="form-control" id="petName" required />
            </div>
            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label for="animalType" class="form-label fw-medium"
                  >Tipo</label
                >
                <select class="form-select" id="animalType" required>
                  <option value="">Seleccionar...</option>
                  <option value="dog">Perro</option>
                  <option value="cat">Gato</option>
                  <option value="bird">Ave</option>
                  <option value="other">Otro</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="breed" class="form-label fw-medium">Raza</label>
                <input type="text" class="form-control" id="breed" required />
              </div>
            </div>
            <div class="mb-3">
              <label for="age" class="form-label fw-medium">Edad</label>
              <input
                type="number"
                class="form-control"
                id="age"
                min="0"
                max="30"
                required
              />
            </div>
          </div>

          <!-- Información del dueño -->
          <div class="mb-4">
            <h6
              class="section-title fw-bold text-primary border-bottom pb-2 mb-3"
            >
              <i class="fas fa-user me-2"></i> Datos del Dueño
            </h6>
            <div class="mb-3">
              <label for="ownerName" class="form-label fw-medium"
                >Nombre Completo</label
              >
              <input type="text" class="form-control" id="ownerName" required />
            </div>
            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label fw-medium">Teléfono</label>
                <input type="tel" class="form-control" id="phone" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label fw-medium">Email</label>
                <input type="email" class="form-control" id="email" />
              </div>
            </div>
          </div>

          <!-- Detalles de la cita -->
          <div class="mb-4">
            <h6
              class="section-title fw-bold text-primary border-bottom pb-2 mb-3"
            >
              <i class="fas fa-calendar-day me-2"></i> Detalles de la Cita
            </h6>
            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label for="appointmentDate" class="form-label fw-medium"
                  >Fecha</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="appointmentDate"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="appointmentTime" class="form-label fw-medium"
                  >Hora</label
                >
                <input
                  type="time"
                  class="form-control"
                  id="appointmentTime"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label fw-medium"
                >Motivo de la Consulta</label
              >
              <textarea
                class="form-control"
                id="description"
                rows="3"
                placeholder="Describa el motivo de la cita..."
              ></textarea>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary py-2 fw-medium">
              <i class="fas fa-save me-1"></i> Guardar Cita
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary py-2"
              id="cancelFormBtn"
            >
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- Gráficos estadísticos -->
      <div class="chart-container bg-white rounded-4 shadow-sm p-4">
        <h5 class="chart-title fw-bold text-primary mb-4">
          <i class="fas fa-chart-pie me-2"></i> Estadísticas de Citas
        </h5>
        <div class="chart-card position-relative" style="height: 200px">
          <canvas id="statsCanvas"></canvas>
        </div>
        <div class="row mt-4 text-center">
          <div class="col-4">
            <div class="fw-bold text-warning fs-4" id="pendingCount">0</div>
            <small class="text-muted">Pendientes</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-success fs-4" id="acceptedCount">0</div>
            <small class="text-muted">Aceptadas</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-danger fs-4" id="rejectedCount">0</div>
            <small class="text-muted">Rechazadas</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts y estilos adicionales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Datos de ejemplo para las citas
  let appointments = {{ appointments_json|safe }};

  // Variables globales
  let currentAppointmentId = null
  let chart = null

  // Inicializar gráfico
  function initChart() {
    const ctx = document.getElementById('statsCanvas').getContext('2d')

    // Actualizar conteos
    const pending = appointments.filter((a) => a.status === 'pending').length
    const accepted = appointments.filter((a) => a.status === 'accepted').length
    const rejected = appointments.filter((a) => a.status === 'rejected').length

    document.getElementById('pendingCount').textContent = pending
    document.getElementById('acceptedCount').textContent = accepted
    document.getElementById('rejectedCount').textContent = rejected

    // Destruir gráfico anterior si existe
    if (chart) {
      chart.destroy()
    }

    chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Pendientes', 'Aceptadas', 'Rechazadas'],
        datasets: [
          {
            data: [pending, accepted, rejected],
            backgroundColor: ['#f59e0b', '#10b981', '#ef4444'],
            borderColor: '#ffffff',
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: "'Poppins', sans-serif",
                size: 12,
              },
            },
          },
          tooltip: {
            backgroundColor: 'rgba(31, 41, 55, 0.9)',
            titleFont: {
              family: "'Poppins', sans-serif",
              size: 13,
            },
            bodyFont: {
              family: "'Poppins', sans-serif",
              size: 12,
            },
            padding: 12,
            cornerRadius: 8,
            displayColors: false,
          },
        },
        cutout: '60%',
      },
    })
  }

  // Renderizar citas
  function renderAppointments() {
    const container = document.getElementById('appointmentsList')
    container.innerHTML = ''

    appointments.forEach((appointment) => {
      const icon =
        appointment.animalType === 'dog'
          ? 'fas fa-dog'
          : appointment.animalType === 'cat'
          ? 'fas fa-cat'
          : appointment.animalType === 'bird'
          ? 'fas fa-dove'
          : 'fas fa-paw'

      const statusText =
        appointment.status === 'accepted'
          ? 'Confirmada'
          : appointment.status === 'rejected'
          ? 'Cancelada'
          : 'Pendiente'

      const statusClass =
        appointment.status === 'accepted'
          ? 'bg-success'
          : appointment.status === 'rejected'
          ? 'bg-danger'
          : 'bg-warning'

      let buttons = ''
      let editButton = ''

      // Botón de edición SOLO para citas aceptadas
      if (appointment.status === 'accepted') {
        editButton = `
          <button class="btn btn-sm btn-outline-primary action-btn" onclick="editAppointment(${appointment.id})">
            <i class="fas fa-edit me-1"></i> Editar
          </button>
        `
      }

      if (appointment.status === 'pending') {
        buttons = `
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-sm btn-success action-btn" onclick="updateAppointmentStatus(this, 'accepted')">
              <i class="fas fa-check me-1"></i> Confirmar
            </button>
            <button class="btn btn-sm btn-danger action-btn" onclick="updateAppointmentStatus(this, 'rejected')">
              <i class="fas fa-times me-1"></i> Rechazar
            </button>
            ${editButton}
          </div>
        `
      } else if (appointment.status === 'accepted') {
        buttons = `
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-sm btn-outline-secondary action-btn" disabled>
              <i class="fas fa-check me-1"></i> Confirmada
            </button>
            <button class="btn btn-sm btn-danger action-btn" onclick="updateAppointmentStatus(this, 'rejected')">
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
            ${editButton}
          </div>
        `
      } else if (appointment.status === 'rejected') {
        buttons = `
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-sm btn-outline-success action-btn" onclick="updateAppointmentStatus(this, 'pending')">
              <i class="fas fa-undo me-1"></i> Reactivar
            </button>
            <button class="btn btn-sm btn-outline-secondary action-btn" disabled>
              <i class="fas fa-times me-1"></i> Cancelada
            </button>
          </div>
        `
      }

      // Generar imagen según tipo de animal
      const bgClass =
        appointment.animalType === 'dog'
          ? 'bg-primary'
          : appointment.animalType === 'cat'
          ? 'bg-danger'
          : appointment.animalType === 'bird'
          ? 'bg-info'
          : 'bg-success'

      const iconClass =
        appointment.animalType === 'dog'
          ? 'fas fa-dog'
          : appointment.animalType === 'cat'
          ? 'fas fa-cat'
          : appointment.animalType === 'bird'
          ? 'fas fa-dove'
          : 'fas fa-paw'

      const cardHTML = `
        <div class="col-12">
          <div class="card shadow-sm mb-3 appointment-card" data-status="${
            appointment.status
          }" 
               data-date="${appointment.date}" data-animal-type="${
        appointment.animalType
      }" 
               data-id="${appointment.id}">
            <div class="row g-0">
              <div class="col-md-4 d-flex align-items-center justify-content-center ${bgClass} bg-opacity-10 p-4">
                <div class="text-center">
                  <i class="${iconClass} fa-3x ${bgClass} p-3 rounded-circle text-white"></i>
                  <div class="mt-3 fw-bold">${appointment.petName}</div>
                </div>
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title fw-bold">${appointment.petName}</h5>
                    <span class="badge ${statusClass} rounded-pill">${statusText}</span>
                  </div>
                  
                  <div class="d-flex align-items-center mb-2 text-muted">
                    <i class="fas fa-clock me-2"></i> ${formatDate(
                      appointment.date
                    )} - ${appointment.time}
                  </div>
                  
                  <p class="card-text mb-2"><i class="${icon} me-1"></i> ${capitalize(
        appointment.animalType
      )} • ${appointment.breed}</p>
                  <p class="card-text"><i class="fas fa-birthday-cake me-1"></i> ${
                    appointment.age
                  } ${appointment.age === 1 ? 'año' : 'años'}</p>
                  
                  <div class="bg-light p-3 rounded mt-3">
                    <p class="mb-0"><strong>Motivo:</strong> ${
                      appointment.description
                    }</p>
                    <p class="mt-1 mb-0"><strong>Dueño:</strong> ${
                      appointment.ownerName
                    } • ${appointment.phone}</p>
                  </div>
                  
                  ${buttons}
                </div>
              </div>
            </div>
          </div>
        </div>
      `

      container.insertAdjacentHTML('beforeend', cardHTML)
    })
  }

  // Actualizar estado de la cita
  function updateAppointmentStatus(button, newStatus) {
    const appointmentCard = button.closest('.appointment-card')
    const appointmentId = parseInt(appointmentCard.dataset.id)
    currentAppointmentId = appointmentId

    // Actualizar estado en el array
    const appointment = appointments.find((a) => a.id === appointmentId)
    if (appointment) {
      appointment.status = newStatus
    }

    renderAppointments()
    initChart()
  }

  // Filtrar citas
  function filterAppointments() {
    const statusFilter = document.getElementById('filterStatus').value
    const dateFilter = document.getElementById('filterDate').value

    document
      .querySelectorAll('#appointmentsList .appointment-card')
      .forEach((card) => {
        const cardStatus = card.dataset.status
        const cardDate = card.dataset.date

        let showCard = true

        if (statusFilter !== 'all' && cardStatus !== statusFilter) {
          showCard = false
        }

        if (dateFilter && cardDate !== dateFilter) {
          showCard = false
        }

        card.style.display = showCard ? 'block' : 'none'
      })
  }

  // CRUD de citas
  document
    .getElementById('appointmentForm')
    .addEventListener('submit', function (e) {
      e.preventDefault()

      const id = document.getElementById('appointmentId').value
      const petName = document.getElementById('petName').value
      const animalType = document.getElementById('animalType').value
      const breed = document.getElementById('breed').value
      const age = document.getElementById('age').value
      const ownerName = document.getElementById('ownerName').value
      const phone = document.getElementById('phone').value
      const email = document.getElementById('email').value
      const date = document.getElementById('appointmentDate').value
      const time = document.getElementById('appointmentTime').value
      const description = document.getElementById('description').value

      if (id) {
        // Editar cita existente
        const index = appointments.findIndex((a) => a.id == id)
        if (index !== -1) {
          appointments[index] = {
            id: parseInt(id),
            petName,
            animalType,
            breed,
            age: parseInt(age),
            ownerName,
            phone,
            email,
            date,
            time,
            description,
            status: appointments[index].status,
          }
        }
      } else {
        // Agregar nueva cita
        const newId =
          appointments.length > 0
            ? Math.max(...appointments.map((a) => a.id)) + 1
            : 1
        appointments.push({
          id: newId,
          petName,
          animalType,
          breed,
          age: parseInt(age),
          ownerName,
          phone,
          email,
          date,
          time,
          description,
          status: 'pending',
        })
      }

      renderAppointments()
      resetForm()
      initChart()
    })

  // Editar cita
  function editAppointment(id) {
    const appointment = appointments.find((a) => a.id == id)
    if (!appointment) return

    // Remover clase de edición anterior
    document.querySelectorAll('.appointment-card').forEach((card) => {
      card.classList.remove('border-primary')
    })

    // Resaltar cita actual
    const appointmentCard = document.querySelector(
      `.appointment-card[data-id="${id}"]`
    )
    if (appointmentCard) {
      appointmentCard.classList.add('border-primary')
    }

    // Cargar datos en el formulario
    document.getElementById('appointmentId').value = appointment.id
    document.getElementById('petName').value = appointment.petName
    document.getElementById('animalType').value = appointment.animalType
    document.getElementById('breed').value = appointment.breed
    document.getElementById('age').value = appointment.age
    document.getElementById('ownerName').value = appointment.ownerName
    document.getElementById('phone').value = appointment.phone
    document.getElementById('email').value = appointment.email
    document.getElementById('appointmentDate').value = appointment.date
    document.getElementById('appointmentTime').value = appointment.time
    document.getElementById('description').value = appointment.description

    // Scroll al formulario
    document
      .getElementById('appointmentForm')
      .scrollIntoView({ behavior: 'smooth' })
  }

  // Reiniciar formulario
  function resetForm() {
    document.getElementById('appointmentForm').reset()
    document.getElementById('appointmentId').value = ''

    // Quitar resaltado de edición
    document.querySelectorAll('.appointment-card').forEach((card) => {
      card.classList.remove('border-primary')
    })
  }

  // Funciones auxiliares
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1)
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr)
    const options = { day: '2-digit', month: 'short' }
    return date.toLocaleDateString('es-ES', options)
  }

  // Inicialización
  document.addEventListener('DOMContentLoaded', function () {
    renderAppointments()
    initChart()

    // Establecer fecha mínima como hoy en el formulario
    const today = new Date().toISOString().split('T')[0]
    document.getElementById('appointmentDate').min = today

    // Event listeners para filtros
    document
      .getElementById('filterStatus')
      .addEventListener('change', filterAppointments)
    document
      .getElementById('filterDate')
      .addEventListener('change', filterAppointments)

    // Establecer fecha de hoy como predeterminada en el filtro
    document.getElementById('filterDate').value = today

    // Botón de nueva cita
    document
      .getElementById('newAppointmentBtn')
      .addEventListener('click', function () {
        resetForm()
        document
          .getElementById('appointmentForm')
          .scrollIntoView({ behavior: 'smooth' })
      })

    // Botón de cancelar formulario
    document
      .getElementById('cancelFormBtn')
      .addEventListener('click', resetForm)
  })
</script>

<style>
  /* Estilos específicos para gestión de citas */
  .dashboard-header {
    background: linear-gradient(
      135deg,
      rgba(26, 86, 219, 0.05),
      rgba(14, 116, 144, 0.05)
    );
  }

  .stats-card {
    transition: all 0.3s ease;
  }

  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  .stats-pending {
    background: linear-gradient(
      135deg,
      rgba(254, 243, 199, 0.8),
      rgba(253, 230, 138, 0.8)
    );
    color: #92400e;
  }

  .stats-accepted {
    background: linear-gradient(
      135deg,
      rgba(209, 250, 229, 0.8),
      rgba(167, 243, 208, 0.8)
    );
    color: #065f46;
  }

  .stats-rejected {
    background: linear-gradient(
      135deg,
      rgba(254, 226, 226, 0.8),
      rgba(254, 202, 202, 0.8)
    );
    color: #b91c1c;
  }

  .filter-card,
  .form-section,
  .chart-container {
    transition: all 0.3s ease;
  }

  .filter-card:hover,
  .form-section:hover,
  .chart-container:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .appointment-card {
    transition: all 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
  }

  .appointment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .appointment-card.border-primary {
    border-width: 2px;
    box-shadow: 0 0 0 0.25rem rgba(26, 86, 219, 0.15);
  }

  .action-btn {
    min-width: 100px;
    padding: 8px 15px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .action-btn {
      width: 100%;
    }
  }
</style>
{% endblock %}
